# UCEF3643 - Confidential ERC-3643 Token

Combines UCEF privacy features with ERC-3643 (T-REX) compliance for regulated security tokens.

## Overview

UCEF3643 merges two powerful frameworks:

- **UCEF**: Programmable confidentiality for balances and events
- **ERC-3643**: Identity verification, compliance checks, and transfer restrictions

This enables regulated entities to issue compliant security tokens while protecting sensitive financial data.

## Key Features

| Feature                   | Description                                     |
| ------------------------- | ----------------------------------------------- |
| **Confidential Balances** | Only account owner or identity can view balance |
| **Private Events**        | Transfer, Approval, Freeze events are private   |
| **Identity Verification** | ERC-3643 identity registry integration          |
| **Compliance Checks**     | Modular compliance rules on transfers           |
| **Token Freezing**        | Freeze tokens for regulatory actions            |
| **Auditor Role**          | Designated auditors can view all private events |
| **Agent Management**      | Authorized agents for administrative actions    |

## How It Works

### Private Balances

```solidity
function balanceOf(address account) public view override returns (uint256) {
    bool authorized = _authorizeBalance(account);
    return authorized ? _balanceOf(account) : 0;
}

function _authorizeBalance(address account) internal view virtual returns (bool) {
    require(
        msg.sender == account ||
        address(IIdentityRegistry(_tokenIdentityRegistry).identity(msg.sender)) == account,
        "Unauthorized balance access"
    );
    return true;
}
```

Only the account owner or their registered identity can view balances.

### Private Events

All sensitive events are wrapped in `PrivateEvent`:

```solidity
event PrivateEvent(
    address[] allowedViewers,
    bytes32 indexed eventType,
    bytes payload
);
```

**Supported Event Types:**

| Event Type       | Viewers                  |
| ---------------- | ------------------------ |
| `Transfer`       | from, to, auditors       |
| `Approval`       | owner, spender, auditors |
| `TokensFrozen`   | user, auditors           |
| `TokensUnfrozen` | user, auditors           |

### Auditor Role

Auditors receive access to ALL private events for compliance monitoring:

```solidity
// Add an auditor (only agents can call)
function addAuditor(address account) external onlyAgent

// Remove an auditor
function removeAuditor(address account) external onlyAgent

// Replace all auditors
function setAuditors(address[] calldata newAuditors) external onlyAgent

// Get current auditors
function getAuditors() external view returns (address[] memory)
```

## Deployment

### Prerequisites

1. Deploy the T-REX suite (or use existing):
   - ClaimTopicsRegistry
   - TrustedIssuersRegistry
   - IdentityRegistryStorage
   - IdentityRegistry
   - ModularCompliance

2. Configure identity verification for token holders

### Using Hardhat Ignition

```typescript
// ignition/modules/UCEF3643.ts
import { buildModule } from '@nomicfoundation/hardhat-ignition/modules'

export default buildModule('UCEF3643', (m) => {
  const token = m.contract('UCEF3643', [])
  return { token }
})
```

```bash
# Deploy to Silent Data
npx hardhat ignition deploy ignition/modules/UCEF3643.ts --network sdr
```

### Using Deploy Script

The deployment script deploys the complete T-REX suite:

```bash
# Local development
pnpm script deploy-suite

# Silent Data network
pnpm script deploy-suite silentdata
```

This deploys:

- ClaimTopicsRegistry
- TrustedIssuersRegistry
- IdentityRegistryStorage
- IdentityRegistry
- ModularCompliance
- UCEF3643 Token

### Available Ignition Modules

| Module          | Description                                      |
| --------------- | ------------------------------------------------ |
| `UCEF3643`      | Basic token without initialization               |
| `UCEF3643Init`  | Token with mock registry/compliance, initialized |
| `UCEF3643Proxy` | Token with proxy pattern for upgradability       |

## Integration with dApp

### Reading Balances

```typescript
import {
  SilentDataRollupProvider,
  SilentDataRollupContract,
} from '@appliedblockchain/silentdatarollup-ethers-provider'

const provider = new SilentDataRollupProvider({
  rpcUrl: 'YOUR_RPC_URL',
  privateKey: 'YOUR_PRIVATE_KEY',
})

const token = new SilentDataRollupContract({
  address: tokenAddress,
  abi: UCEF3643_ABI,
  runner: provider,
  contractMethodsToSign: ['balanceOf', 'allowance'],
})

// Only works if you're the account owner or their identity
const balance = await token.balanceOf(myAddress)
```

### Listening to Private Events

```typescript
import { SDInterface } from '@appliedblockchain/silentdatarollup-ethers-provider'

const sdInterface = new SDInterface([
  ...UCEF3643_ABI,
  'event Transfer(address from, address to, uint256 value)',
  'event Approval(address owner, address spender, uint256 value)',
  'event TokensFrozen(address user, uint256 amount)',
  'event TokensUnfrozen(address user, uint256 amount)',
])

// Get private events (only those you're authorized to see)
const logs = await provider.getPrivateLogs({
  address: tokenAddress,
})

for (const log of logs) {
  const parsed = sdInterface.parseLog(log)
  if (parsed?.innerLog) {
    console.log(parsed.innerLog.name, parsed.innerLog.args)
  }
}
```

## Compliance Features

### Transfer Restrictions

Transfers are validated against:

1. **Wallet Freeze Status**: Frozen wallets cannot send or receive
2. **Available Balance**: Amount must not exceed unfrozen balance
3. **Identity Verification**: Recipient must be verified in registry
4. **Compliance Rules**: ModularCompliance must approve transfer

```solidity
function transfer(address _to, uint256 _amount) public override returns (bool) {
    require(!_frozen[_to] && !_frozen[msg.sender], "wallet is frozen");
    require(_amount <= _balanceOf(msg.sender) - _frozenTokens[msg.sender], "Insufficient Balance");
    if (_tokenIdentityRegistry.isVerified(_to) &&
        _tokenCompliance.canTransfer(msg.sender, _to, _amount)) {
        _transfer(msg.sender, _to, _amount);
        _tokenCompliance.transferred(msg.sender, _to, _amount);
        return true;
    }
    revert("Transfer not possible");
}
```

### Token Freezing

Agents can freeze tokens for compliance actions:

```solidity
// Freeze specific amount of tokens
function freezePartialTokens(address _userAddress, uint256 _amount) public onlyAgent

// Unfreeze tokens
function unfreezePartialTokens(address _userAddress, uint256 _amount) public onlyAgent
```

### Forced Transfers

Agents can force transfers (e.g., for recovery or compliance):

```solidity
function forcedTransfer(address _from, address _to, uint256 _amount) public onlyAgent
```

## Use Cases

1. **Security Token Offerings (STOs)**: Issue compliant securities with private balances
2. **Real Estate Tokenization**: Private ownership records with transfer restrictions
3. **Private Equity**: Confidential shareholding with accredited investor checks
4. **Regulated DeFi**: Compliant lending/borrowing with identity verification

## Comparison

| Feature               | Standard ERC-20 | ERC-3643 | UCEF | UCEF3643 |
| --------------------- | --------------- | -------- | ---- | -------- |
| Confidential Balances | ❌              | ❌       | ✅   | ✅       |
| Private Events        | ❌              | ❌       | ✅   | ✅       |
| Identity Verification | ❌              | ✅       | ❌   | ✅       |
| Compliance Module     | ❌              | ✅       | ❌   | ✅       |
| Token Freezing        | ❌              | ✅       | ❌   | ✅       |
| Auditor Role          | ❌              | ❌       | ❌   | ✅       |

## Resources

- [UCEF3643 Repository](https://github.com/appliedblockchain/confidential-erc-3643)
- [ERC-3643 Standard](https://erc3643.org/)
- [T-REX Documentation](https://docs.tokeny.com/)
- [UCEF Framework](./UCEF.md)
